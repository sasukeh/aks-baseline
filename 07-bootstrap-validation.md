# クラスターがブートストラップされ、GitOps に登録されていることを確認する

[AKSクラスター](./06-aks-cluster.md)がデプロイされたので、次に、クラスターがGitOps管理ソリューション、Fluxの場合、に登録されていることを確認します。

## 手順

GitOps は、チームが Kubernetes マニフェストファイルを作成し、git リポジトリに永続化し、変更が発生すると自動的にクラスターに適用できるようにすることを可能にします。このリファレンス実装では、クラスターベースラインに焦点を当てているため、Flux はクラスターのレベルの問題を管理しています。これは、Flux を介してワークロードレベルの問題を管理することとは異なり、通常はクラスター内の追加の Flux 構成によって行われます。ネームスペース `cluster-baseline-settings` は、クラスターブートストラップ構成をワークロード構成から論理的に分離するために使用されます。適用されるマニフェストの例:

* AKS で管理されている Azure AD インテグレーションのためのクラスター ロール バインディング
* Azure Monitor for Containers のクラスター全体の構成
* ワークロードのネームスペース `a0008`

1. `kubectl` 1.24 かそれ以上をインストールします。(`kubectl` は±1つのKubernetesバージョンをサポートします。)

   ```bash
   sudo az aks install-cli
   kubectl version --client
   ```

   > `kubectl` 1.24 からは、Azure AD 認証のための `kubelogin` 資格情報（exec）プラグインが必要になります。`az aks install-cli` を介して `kubectl` をインストールすると、これがすでに行われますが、異なる方法で `kubectl` をインストールする場合は、`kubelogin` が[インストール](https://github.com/Azure/kubelogin#getting-started)されていることを確認してください。

2. クラスター名を取得します。

   ```bash
   AKS_CLUSTER_NAME=$(az aks list -g rg-bu0001a0008 --query '[0].name' -o tsv)
   echo AKS_CLUSTER_NAME: $AKS_CLUSTER_NAME
   ```

3. AKS の `kubectl` 資格情報を取得します。

   > [Azure Active Directory 統合](03-aad.md)ステップで、クラスターを AAD グループによる RBAC で管理するように設定しました。これは初めて使用しているものです。`az aks get-credentials` は、クラスターに対してコマンドを発行できるように `kubectl` コンテキストを設定します。Azure AD と AKS クラスターを統合するときに Azure AD を有効にした場合でも、Azure ユーザーはクラスター リソースに十分な権限を持っているため、このコマンドに `--admin` スイッチを使用して AKS クラスターにアクセスできます。このスイッチは Azure AD をバイパスし、代わりにクライアント証明書認証を使用します。これは私たちが行いたくないことです。そのため、このプラクティスを防ぐために、ローカル アカウント アクセス（例：`clusterAdmin` または `clusterMonitoringUser`）は明示的に無効になっています。
   >
   > 次のステップでは、Kubernetes RBAC の管理者ロールをバックする Azure AD セキュリティ グループに追加されたユーザーでログインします。最初の `kubectl` コマンドを実行すると、AAD ログイン プロセスが起動し、選択した _ユーザー_ を認証します。そのユーザーは、Kubernetes RBAC を使用してアクションを実行します。ログインに使用するユーザーは、`cluster-admin` ClusterRole にバインドされた AAD グループのメンバーである必要があります。簡単にするために、[Azure Active Directory 統合](03-aad.md)で作成した "break-glass" 管理者ユーザー（`bu0001a0008-admin`）または [`cluster-rbac.yaml`](cluster-manifests/cluster-rbac.yaml) ファイルで `cluster-admin` グループ割り当てに割り当てたユーザーを使用できます。

   ```bash
   az aks get-credentials -g rg-bu0001a0008 -n $AKS_CLUSTER_NAME
   ```

   :warning: この時点で、2つの重要なステップが行われています。

      * `az aks get-credentials` コマンドは、前に作成した AKS クラスターへの参照を含む `kubeconfig` を取得します。
      * 実際にクラスターを使用するには、認証する必要があります。そのためには、`kubectl` コマンドを実行します。この段階では、Azure Active Directory に対して認証するように求められます。たとえば、次のコマンドを実行します。

   ```bash
   kubectl get nodes
   ```

   認証が成功すると、`kubeconfig` ファイルに `access-token` などの新しい項目が追加されます。このプロセスの詳細については、[関連するドキュメント](https://kubernetes.io/docs/reference/access-authn-authz/authentication/#openid-connect-tokens)を参照してください。

4. クラスターのブートストラップが正しく行われていることを確認します。

   Flux エクステンションを使用した Flux のブートストラッププロセスによって、次のようなものが設定されています。

   * ワークロードの名前空間 `a0008`
   * kured のインストール

   ```bash
   kubectl get namespaces
   kubectl get all -n cluster-baseline-settings
   ```

   これらのコマンドは、Flux GitOps エクステンションによってクラスターに自動的に実行されたブートストラッププロセスの結果を示します。このコンテンツは [`cluster-manifests`](./cluster-manifests) と同じ内容であり、そこにコミットを行うと、変更を行った数分以内にクラスターに反映されます。

これのすべての最終結果は、クラスターのブートストラッププロセスのいずれの部分においても `kubectl` が必要とされなかったことです。`kubectl` ベースのアクセスの使用は、緊急のブレークフィックスの状況にのみ予約され、このクラスターの日常的な構成操作には使用されるべきではありません。Azure リソース定義のテンプレートと、GitOps エクステンションを介したマニフェストのブートストラップの間で、すべての通常の構成活動を行うには、`kubectl` の使用が必要ありません。ただし、今後のワークロードのデプロイメントには、SDLC コンポーネントがワークロードのスコープに含まれていないため、これはインフラストラクチャとベースライン構成に焦点を当てています。

## その他

Flux の AKS 拡張を使うことで、Azure でクラスターリソースが作成された直後にすぐに適用されるシームレスなブートストラッププロセスを提供します。また、そのブートストラップをリソーステンプレートとして含めることもでき、これにより IaC 戦略と一致させることができます。代わりに、クラスターがデプロイされた後にブートストラップを適用し、そのプロセスをクラスターのライフサイクル外で管理することもできます。これにより、クラスターがデプロイされてからブートストラップが適用されるまでの長期間のウィンドウが開かれます。

さらに、Flux は拡張としてインストールする必要はなく、代わりに選択した GitOps オペレーター（ArgoCD など）を外部ブートストラッププロセスの一部としてインストールすることができます。

## 推奨事項

クラスターを内部プロセスとツールにすぐに登録するために、実際のクラスターのデプロイメントにできるだけ近い場所で発生する明確に定義されたブートストラッププロセスを持つことをお勧めします。GitOps は、この目的の達成に適しており、クラスターのブートストラッププロセスと、オプションでワークロードレベルの問題に対して、GitOps の使用を探索することをお勧めします。GitOps は、一貫性とスケールの簡単さのために、多くのクラスター（多くのクラスター）の管理に最適な位置づけがされています。小規模なインスタンス数の AKS デプロイメントでは、より手動（デプロイメントパイプラインを介して）のブートストラップが一般的です。どちらのプロセスも、どちらのクラスター拡張も機能します。組織とチーム内で望ましい目標と制約に合わせたブートストラッププロセスを使用します。

### 次のステップ

:arrow_forward: [ワークロードの準備を行い、必要なものをインストールします](./08-workload-prerequisites.md)
